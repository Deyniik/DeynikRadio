<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deynik Radio - Micro-Frontend Architecture</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìª</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="retro"> <div id="header-container" class="header-container">
        <header>
            <div class="header-left">
                <button id="themeSwitcher" class="theme-switcher"><i class="fas fa-palette"></i> –†–µ—Ç—Ä–æ</button>
            </div>
            <div class="header-center">
                <h1>üìª Deynik Radio</h1>
            </div>
            <div class="header-right">
                <button id="feedbackBtn" class="feedback-btn"><i class="fas fa-star"></i> –û—Ç–∑—ã–≤—ã</button>
                <button id="supportBtn" class="support-btn"><i class="fas fa-heart"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
                <div id="authContainer">
                    <button id="googleLoginBtn" class="google-login-btn" onclick="window.DeynikRadioSync.googleLogin()">
                        <i class="fab fa-google"></i> –í–æ–π—Ç–∏
                    </button>
                    <div id="userProfile" class="user-profile" style="display: none;">
                        <div id="userAvatar" class="user-avatar"></div>
                        <span id="userName" class="user-name"></span>
                        <i class="fas fa-caret-down"></i>
                        <div id="user-dropdown" class="user-dropdown">
                            <div class="dropdown-item" onclick="showNicknameModal()"><i class="fas fa-user-edit"></i> –ù–∏–∫–Ω–µ–π–º</div>
                            <div class="dropdown-item" onclick="window.DeynikRadioSync.logout()"><i class="fas fa-sign-out-alt"></i> –í—ã—Ö–æ–¥</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <main class="main-layout">

        <aside id="sidebar-left-container" class="side-panel left-panel">
            <div class="stations-header">
                <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                <i class="fas fa-bars"></i>
            </div>
            <div id="categoriesContainer" class="categories-container"></div>
            <div class="stations-header">
                <h2>–°—Ç–∞–Ω—Ü–∏–∏</h2>
            </div>
            <ul id="stationList" class="station-list"></ul>
            <button id="randomStationBtn" class="random-station-btn">
                <i class="fas fa-random"></i> –°–ª—É—á–∞–π–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è
            </button>
        </aside>

        <section id="main-content-container" class="main-content">
            <div class="gif-container">
                <div id="playback-indicator" class="playback-indicator"></div>
                <div id="gif-placeholder" class="gif-placeholder">
                    <img id="mainGif" src="https://i.pinimg.com/originals/7d/04/0e/7d040e94931427709008aaeda14db9c8.gif" alt="Visualization GIF" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                
                <div id="visualization" class="visualization">
                    <script>
                        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∞—Ä–æ–≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        const visualization = document.getElementById('visualization');
                        for (let i = 0; i < 60; i++) {
                            const bar = document.createElement('div');
                            bar.className = 'bar';
                            visualization.appendChild(bar);
                        }
                    </script>
                </div>

                <div class="now-playing">
                    <h3 id="current-station-display">Deynik Radio</h3>
                    <p>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: <span id="current-track">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span> - <span id="current-artist">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></p>
                </div>
                <div id="heartEffect" class="heart-effect">
                    <i class="fas fa-heart"></i>
                    <div class="heart-text">Love!</div>
                </div>
            </div>
        </section>

        <aside id="sidebar-right-container" class="side-panel right-panel">
            <div class="chat-container">
                <div class="chat-header">
                    <i class="fas fa-comments"></i>
                    <h2>–ß–∞—Ç</h2>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div id="mentionsList" class="mentions-list"></div>
                <div id="replyIndicator" style="display: none;" class="reply-indicator">
                    –û—Ç–≤–µ—Ç –Ω–∞: <span id="replyUsername"></span>
                    <button id="cancelReplyBtn" class="reply-cancel-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="chat-input-container">
                    <button id="emoji-btn" class="emoji-btn"><i class="far fa-smile"></i></button>
                    <button id="gif-btn" class="gif-btn"><i class="fas fa-gift"></i></button>
                    <input type="text" id="chat-input" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ @–Ω–∏–∫">
                    <button id="chat-send-btn" class="btn btn-send"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </aside>
    </main>

    <footer id="player-container" class="player-footer">
        <div class="player-container">
            <div class="player-top">
                <div class="player-left">
                    <div id="player-icon" class="player-icon">
                        <i class="fas fa-compact-disc"></i>
                    </div>
                    <div class="station-text">
                        <h2 id="player-station">Euro Phard</h2>
                        <p id="player-description">–õ—É—á—à–∏–µ —Ö–∏—Ç—ã 90-—Ö –∏ 00-—Ö</p>
                    </div>
                </div>

                <div class="player-center">
                    <button id="btn-prev" class="btn" disabled><i class="fas fa-backward"></i></button>
                    <button id="btn-play" class="btn btn-play" onclick="window.DeynikRadioSync.togglePlay()">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="btn-next" class="btn" onclick="window.DeynikRadioSync.nextStation()"><i class="fas fa-forward"></i></button>
                    <button id="btn-refresh" class="btn"><i class="fas fa-redo"></i></button>
                    <img id="nextGif" class="next-gif" src="" alt="Next track preview" style="display: none;">
                </div>

                <div class="player-buttons">
                    <div class="btn-like-container">
                        <span id="likes-count-bottom" class="likes-count-bottom">0</span>
                        <button id="btn-like" class="btn btn-like">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="player-bottom">
                <div class="volume-control">
                    <i class="fas fa-volume-down volume-icon"></i>
                    <input type="range" min="0" max="100" value="70" class="volume-slider" id="volumeSlider">
                    <i class="fas fa-volume-up volume-icon"></i>
                </div>
            </div>
        </div>
    </footer>

    <script src="sync.js"></script> 
    
    <script>
        // –°–∫—Ä–∏–ø—Ç –∏–∑ header.html (–ß–∞—Å—Ç—å 1)
        function updateHeaderUI() {
            const state = window.DeynikRadioSync.state;
            const authContainer = document.getElementById('authContainer');
            const loginBtn = document.getElementById('googleLoginBtn');
            const profileDiv = document.getElementById('userProfile');
            const avatarDiv = document.getElementById('userAvatar');
            const nameSpan = document.getElementById('userName');

            if (state.currentUser) {
                loginBtn.style.display = 'none';
                profileDiv.style.display = 'flex';
                const nickname = state.userNickname || state.currentUser.displayName;
                nameSpan.textContent = nickname;
                avatarDiv.textContent = nickname.charAt(0).toUpperCase();
            } else {
                loginBtn.style.display = 'flex';
                profileDiv.style.display = 'none';
            }
            
            profileDiv.onclick = (e) => {
                e.stopPropagation();
                document.getElementById('user-dropdown').classList.toggle('show');
            };
            document.addEventListener('click', () => document.getElementById('user-dropdown').classList.remove('show'));
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–º–µ–Ω—ã –Ω–∏–∫–∞
            window.showNicknameModal = () => alert('–§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.');
        }
        document.addEventListener('authChange', updateHeaderUI);
        updateHeaderUI();

        // –°–∫—Ä–∏–ø—Ç –∏–∑ sidebar-left.html (–ß–∞—Å—Ç—å 2)
        const sync_l = window.DeynikRadioSync;
        const stations_l = sync_l.stations;
        const stationList_l = document.getElementById('stationList');
        const categoriesContainer_l = document.getElementById('categoriesContainer');
        const stationIds_l = Object.keys(stations_l);

        function renderStationList(selectedCategory = 'all') {
            stationList_l.innerHTML = '';
            const fragment = document.createDocumentFragment();

            stationIds_l.forEach(id => {
                const station = stations_l[id];
                if (selectedCategory !== 'all' && station.category !== selectedCategory) return;
                
                const li = document.createElement('li');
                li.setAttribute('data-station-id', id);
                li.innerHTML = `
                    <span class="station-icon"><i class="${station.icon}"></i></span>
                    <span class="station-name">${station.name}</span>
                    <span class="station-likes"><i class="fas fa-heart"></i> <span class="likes-count">0</span></span>
                `;
                li.onclick = () => sync_l.selectStation(id);
                fragment.appendChild(li);
            });

            stationList_l.appendChild(fragment);
            updateActiveStation(sync_l.state.stationId);
        }
        
        function renderCategories() {
            const categories = [...new Set(Object.values(stations_l).map(s => s.category))];
            categoriesContainer_l.innerHTML = '<button class="category-btn active" data-category="all">–í—Å–µ</button>' +
                                            categories.map(cat => `<button class="category-btn" data-category="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`).join('');
            
            categoriesContainer_l.querySelectorAll('.category-btn').forEach(btn => {
                btn.onclick = function() {
                    categoriesContainer_l.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderStationList(this.getAttribute('data-category'));
                };
            });
        }

        function updateActiveStation(stationId) {
            stationList_l.querySelectorAll('li').forEach(li => {
                li.classList.toggle('active', li.getAttribute('data-station-id') === stationId);
            });
        }

        document.getElementById('randomStationBtn').onclick = function() {
            const randomId = stationIds_l[Math.floor(Math.random() * stationIds_l.length)];
            sync_l.selectStation(randomId);
        };

        document.addEventListener('stationSelected', (e) => updateActiveStation(e.detail.station.id));
        renderCategories();
        renderStationList();

        // –°–∫—Ä–∏–ø—Ç –∏–∑ main-content.html (–ß–∞—Å—Ç—å 3)
        const sync_m = window.DeynikRadioSync;
        const mainGif = document.getElementById('mainGif');
        const playbackIndicator = document.getElementById('playback-indicator');

        function updateMainContentUI() {
            const state = sync_m.state;
            const station = sync_m.stations[state.stationId];

            mainGif.src = station.gif;
            playbackIndicator.style.opacity = state.isPlaying ? 1 : 0;
            document.getElementById('current-station-display').textContent = station.name;
            document.getElementById('current-track').textContent = station.currentTrack;
            document.getElementById('current-artist').textContent = station.currentArtist;
        }

        document.addEventListener('stateChanged', (e) => {
            if (e.detail.key === 'isPlaying') {
                playbackIndicator.style.opacity = e.detail.value ? 1 : 0;
            }
        });
        document.addEventListener('stationSelected', updateMainContentUI);
        updateMainContentUI();

        // –°–∫—Ä–∏–ø—Ç –∏–∑ sidebar-right.html (–ß–∞—Å—Ç—å 4)
        const sync_r = window.DeynikRadioSync;
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');
        const replyIndicator = document.getElementById('replyIndicator');
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');
        let replyingToMessage = null;

        function renderChat() {
            chatMessages.innerHTML = '';
            const messages = sync_r.state.chatMessages;

            messages.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                const time = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
                
                let replyHtml = '';
                if (message.replyTo) {
                    replyHtml = `<div class="reply-indicator">–û—Ç–≤–µ—Ç –Ω–∞: ${message.replyTo}</div>`;
                }

                messageEl.innerHTML = `
                    ${replyHtml}
                    <span class="message-user">${message.user}</span>
                    <span class="message-time">${time}</span>: 
                    <span class="message-text">${message.text}</span>
                    <button class="reply-btn" data-message-id="${message.id}" onclick="replyTo_r('${message.id}', '${message.user}')"><i class="fas fa-reply"></i></button>
                    <div class="message-reactions"></div>
                `;
                chatMessages.appendChild(messageEl);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        window.replyTo_r = function(messageId, username) {
            replyingToMessage = messageId;
            document.getElementById('replyUsername').textContent = username;
            replyIndicator.style.display = 'flex';
            chatInput.focus();
        };

        cancelReplyBtn.onclick = () => {
            replyingToMessage = null;
            replyIndicator.style.display = 'none';
        };

        sendBtn.onclick = function() {
            const text = chatInput.value.trim();
            if (text) {
                sync_r.sendChatMessage(text, replyingToMessage);
                chatInput.value = '';
                replyingToMessage = null;
                replyIndicator.style.display = 'none';
            }
        };

        document.addEventListener('chatUpdate', renderChat);
        document.addEventListener('chatMessageSent', renderChat);
        renderChat();

        // –°–∫—Ä–∏–ø—Ç –∏–∑ player.html (–ß–∞—Å—Ç—å 5)
        const sync_p = window.DeynikRadioSync;
        const playButton = document.getElementById('btn-play');
        const playerIcon = document.getElementById('player-icon');
        const volumeSlider = document.getElementById('volumeSlider');

        function updatePlayerUI() {
            const state = sync_p.state;
            const station = sync_p.stations[state.stationId];

            if (state.isPlaying) {
                playButton.innerHTML = '<i class="fas fa-pause"></i>';
                playerIcon.classList.add('playing');
            } else {
                playButton.innerHTML = '<i class="fas fa-play"></i>';
                playerIcon.classList.remove('playing');
            }

            document.getElementById('player-station').textContent = station.name;
            document.getElementById('player-description').textContent = station.description;
            document.getElementById('player-icon').innerHTML = `<i class="${station.icon}"></i>`;
            
            volumeSlider.value = state.volume;
        }

        volumeSlider.oninput = function() {
            sync_p.setVolume(this.value);
        };

        document.addEventListener('stateChanged', updatePlayerUI);
        document.addEventListener('stationSelected', updatePlayerUI);
        updatePlayerUI();
    </script>
</body>
</html>
