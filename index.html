# Профессиональный фоторедактор

Вот полностью переработанный фоторедактор с устранением всех багов, красивым дизайном и плавной работой:

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPhoto Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f0f0f;
            --panel: #1e1e1e;
            --accent: #4361ee;
            --text: #f0f0f0;
            --slider-track: #333;
            --slider-thumb: var(--accent);
            --border: rgba(255,255,255,0.1);
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Шапка */
        .header {
            height: 60px;
            background: var(--panel);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-weight: bold;
            font-size: 18px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Основная рабочая область */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow);
        }

        canvas {
            max-width: 100%;
            max-height: calc(100vh - 180px);
            object-fit: contain;
            transition: all 0.3s;
            border-radius: var(--radius);
        }

        /* Панель инструментов */
        .toolbar {
            height: 60px;
            background: var(--panel);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            border-bottom: 1px solid var(--border);
        }

        .tool-button {
            background: transparent;
            color: var(--text);
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            min-width: 70px;
        }

        .tool-button:hover {
            background: rgba(255,255,255,0.05);
        }

        .tool-button.active {
            color: var(--accent);
            background: rgba(67, 97, 238, 0.1);
        }

        .tool-button i {
            font-size: 16px;
        }

        /* Панель настроек */
        .controls {
            width: 340px;
            background: var(--panel);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border);
            transition: transform 0.3s;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--panel);
        }

        .controls::-webkit-scrollbar {
            width: 6px;
        }

        .controls::-webkit-scrollbar-track {
            background: var(--panel);
        }

        .controls::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 3px;
        }

        .control-group {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: var(--radius);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: var(--accent);
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Стили для ползунков */
        .slider-container {
            margin-bottom: 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }

        .slider-value {
            font-size: 14px;
            color: var(--accent);
            min-width: 40px;
            text-align: right;
        }

        .slider-wrapper {
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--slider-track);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--slider-thumb);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .slider-fill {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 6px;
            background: var(--accent);
            border-radius: 3px;
            pointer-events: none;
        }

        /* Фильтры */
        .filters-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .filters-container::-webkit-scrollbar {
            display: none;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            min-width: 90px;
            flex-shrink: 0;
        }

        .filter-preview {
            width: 90px;
            height: 90px;
            border-radius: var(--radius);
            background-size: cover;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .filter-item.active .filter-preview {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
        }

        .filter-name {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            text-align: center;
            font-weight: 500;
        }

        /* Кнопки загрузки/скачивания */
        .file-input {
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .primary-button {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.3);
        }

        .primary-button:hover {
            background: #3a56d4;
            transform: translateY(-2px);
        }

        .secondary-button {
            background: rgba(255,255,255,0.08);
            color: var(--text);
        }

        .secondary-button:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        /* Цветовые контролы */
        .color-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type="color"] {
            width: 36px;
            height: 36px;
            border: 2px solid var(--slider-track);
            border-radius: 50%;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="color"]:hover {
            transform: scale(1.1);
        }

        .color-hex {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .controls {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                max-width: 340px;
                transform: translateX(100%);
                z-index: 10;
                box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            }
            
            .controls.visible {
                transform: translateX(0);
            }
        }

        /* Placeholder */
        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 18px;
            pointer-events: none;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: var(--radius);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="logo">
                <i class="fas fa-camera"></i>
                <span>ProPhoto Editor</span>
            </div>
        </div>

        <div class="main-content">
            <div class="workspace">
                <div class="canvas-container">
                    <canvas id="canvas"></canvas>
                    <div class="placeholder" id="placeholder">
                        <i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <div>Перетащите сюда изображение</div>
                    </div>
                    <div class="loading" id="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <input type="file" id="file-input" class="file-input" accept="image/*">
                    <label for="file-input" class="action-button secondary-button">
                        <i class="fas fa-upload"></i> Загрузить
                    </label>
                    <button id="download-btn" class="action-button primary-button">
                        <i class="fas fa-download"></i> Сохранить
                    </button>
                </div>
            </div>

            <div class="controls" id="controls-panel">
                <div class="control-group">
                    <h3><i class="fas fa-sliders-h"></i> Основные настройки</h3>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Яркость</span>
                            <span class="slider-value" id="brightness-value">0</span>
                        </div>
                        <div class="slider-wrapper">
                            <input type="range" id="brightness-slider" min="-100" max="100" value="0">
                            <div class="slider-fill" id="brightness-fill"></div>
                        </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Контраст</span>
                            <span class="slider-value" id="contrast-value">0</span>
                        </div>
                        <div class="slider-wrapper">
                            <input type="range" id="contrast-slider" min="-100" max="100" value="0">
                            <div class="slider-fill" id="contrast-fill"></div>
                        </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Насыщенность</span>
                            <span class="slider-value" id="saturation-value">0</span>
                        </div>
                        <div class="slider-wrapper">
                            <input type="range" id="saturation-slider" min="-100" max="100" value="0">
                            <div class="slider-fill" id="saturation-fill"></div>
                        </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Теплота</span>
                            <span class="slider-value" id="temperature-value">0</span>
                        </div>
                        <div class="slider-wrapper">
                            <input type="range" id="temperature-slider" min="-100" max="100" value="0">
                            <div class="slider-fill" id="temperature-fill"></div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-magic"></i> Профессиональные фильтры</h3>
                    <div class="filters-container" id="filters-container">
                        <div class="filter-item active" data-filter="none">
                            <div class="filter-preview" style="background: #1e1e1e;"></div>
                            <span class="filter-name">Оригинал</span>
                        </div>
                        <div class="filter-item" data-filter="moody">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #2c3e50, #4ca1af);"></div>
                            <span class="filter-name">Moody</span>
                        </div>
                        <div class="filter-item" data-filter="dramatic">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #000000, #434343);"></div>
                            <span class="filter-name">Dramatic</span>
                        </div>
                        <div class="filter-item" data-filter="vintage">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #f3e7e9, #e3eeff);"></div>
                            <span class="filter-name">Vintage</span>
                        </div>
                        <div class="filter-item" data-filter="cinematic">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #1e3c72, #2a5298);"></div>
                            <span class="filter-name">Cinematic</span>
                        </div>
                        <div class="filter-item" data-filter="noir">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #000000, #434343);"></div>
                            <span class="filter-name">Noir</span>
                        </div>
                        <div class="filter-item" data-filter="sunset">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #ff7e5f, #feb47b);"></div>
                            <span class="filter-name">Sunset</span>
                        </div>
                        <div class="filter-item" data-filter="frost">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #0052D9, #4364F7);"></div>
                            <span class="filter-name">Frost</span>
                        </div>
                        <div class="filter-item" data-filter="mist">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #606c88, #3f4c6b);"></div>
                            <span class="filter-name">Mist</span>
                        </div>
                        <div class="filter-item" data-filter="golden">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #f6d365, #fda085);"></div>
                            <span class="filter-name">Golden</span>
                        </div>
                        <div class="filter-item" data-filter="urban">
                            <div class="filter-preview" style="background: linear-gradient(135deg, #5f2c82, #49a09d);"></div>
                            <span class="filter-name">Urban</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3><i class="fas fa-star"></i> Дополнительные эффекты</h3>
                    <div class="filters-container">
                        <div class="filter-item" data-effect="vignette">
                            <div class="filter-preview" style="background: radial-gradient(circle, transparent 30%, #000 100%);"></div>
                            <span class="filter-name">Виньетка</span>
                        </div>
                        <div class="filter-item" data-effect="grain">
                            <div class="filter-preview" style="background: url('data:image/svg+xml;utf8,<svg viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'noise\'><feTurbulence type=\'fractalNoise\' baseFrequency=\'0.5\' numOctaves=\'3\' stitchTiles=\'stitch\'/></filter><rect width=\'100\' height=\'100\' filter=\'url(%23noise)\'/></svg>') #1e1e1e;"></div>
                            <span class="filter-name">Зерно</span>
                        </div>
                        <div class="filter-item" data-effect="blur">
                            <div class="filter-preview" style="background: #1e1e1e; filter: blur(2px);"></div>
                            <span class="filter-name">Размытие</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="tool-button active" data-tool="adjust">
                <i class="fas fa-sliders-h"></i>
                <span>Коррекция</span>
            </button>
            <button class="tool-button" data-tool="filters">
                <i class="fas fa-magic"></i>
                <span>Фильтры</span>
            </button>
            <button class="tool-button" data-tool="effects">
                <i class="fas fa-star"></i>
                <span>Эффекты</span>
            </button>
            <button class="tool-button" id="toggle-controls">
                <i class="fas fa-chevron-left"></i>
                <span>Панель</span>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Основные элементы
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const fileInput = document.getElementById('file-input');
            const downloadBtn = document.getElementById('download-btn');
            const toggleControlsBtn = document.getElementById('toggle-controls');
            const controlsPanel = document.getElementById('controls-panel');
            const placeholder = document.getElementById('placeholder');
            const loading = document.getElementById('loading');
            const filtersContainer = document.getElementById('filters-container');

            // Ползунки
            const brightnessSlider = document.getElementById('brightness-slider');
            const contrastSlider = document.getElementById('contrast-slider');
            const saturationSlider = document.getElementById('saturation-slider');
            const temperatureSlider = document.getElementById('temperature-slider');

            // Значения ползунков
            const brightnessValue = document.getElementById('brightness-value');
            const contrastValue = document.getElementById('contrast-value');
            const saturationValue = document.getElementById('saturation-value');
            const temperatureValue = document.getElementById('temperature-value');

            // Заполнение ползунков
            const brightnessFill = document.getElementById('brightness-fill');
            const contrastFill = document.getElementById('contrast-fill');
            const saturationFill = document.getElementById('saturation-fill');
            const temperatureFill = document.getElementById('temperature-fill');

            // Фильтры и эффекты
            const filterItems = document.querySelectorAll('.filter-item[data-filter]');
            const effectItems = document.querySelectorAll('.filter-item[data-effect]');
            const toolButtons = document.querySelectorAll('.tool-button');

            // Состояние редактора
            let originalImageData = null;
            let currentImage = null;
            let currentFilter = 'none';
            let activeEffects = new Set();
            let isProcessing = false;
            let imageAspectRatio = 1;

            // Инициализация
            initCanvas();
            setupEventListeners();
            updateSliderFills();
            setupHorizontalScroll();

            function initCanvas() {
                canvas.width = 800;
                canvas.height = 600;
            }

            function setupEventListeners() {
                // Загрузка изображения
                fileInput.addEventListener('change', handleImageUpload);

                // Drag and Drop
                canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    canvas.style.outline = '2px dashed var(--accent)';
                });

                canvas.addEventListener('dragleave', () => {
                    canvas.style.outline = 'none';
                });

                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    canvas.style.outline = 'none';
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleImageUpload({ target: fileInput });
                    }
                });

                // Кнопки действий
                downloadBtn.addEventListener('click', downloadImage);
                toggleControlsBtn.addEventListener('click', toggleControlsPanel);

                // Ползунки
                brightnessSlider.addEventListener('input', updateBrightness);
                contrastSlider.addEventListener('input', updateContrast);
                saturationSlider.addEventListener('input', updateSaturation);
                temperatureSlider.addEventListener('input', updateTemperature);

                // Фильтры
                filterItems.forEach(item => {
                    item.addEventListener('click', () => {
                        if (isProcessing) return;
                        
                        filterItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        currentFilter = item.dataset.filter;
                        applyCurrentSettings();
                    });
                });

                // Эффекты
                effectItems.forEach(item => {
                    item.addEventListener('click', () => {
                        if (isProcessing) return;
                        
                        const effect = item.dataset.effect;
                        if (activeEffects.has(effect)) {
                            activeEffects.delete(effect);
                            item.classList.remove('active');
                        } else {
                            activeEffects.add(effect);
                            item.classList.add('active');
                        }
                        applyCurrentSettings();
                    });
                });

                // Инструменты
                toolButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        toolButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            }

            function setupHorizontalScroll() {
                let isDown = false;
                let startX;
                let scrollLeft;

                filtersContainer.addEventListener('mousedown', (e) => {
                    isDown = true;
                    startX = e.pageX - filtersContainer.offsetLeft;
                    scrollLeft = filtersContainer.scrollLeft;
                    filtersContainer.style.cursor = 'grabbing';
                });

                filtersContainer.addEventListener('mouseleave', () => {
                    isDown = false;
                    filtersContainer.style.cursor = 'grab';
                });

                filtersContainer.addEventListener('mouseup', () => {
                    isDown = false;
                    filtersContainer.style.cursor = 'grab';
                });

                filtersContainer.addEventListener('mousemove', (e) => {
                    if(!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - filtersContainer.offsetLeft;
                    const walk = (x - startX) * 2;
                    filtersContainer.scrollLeft = scrollLeft - walk;
                });
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                showLoading();

                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        imageAspectRatio = img.width / img.height;
                        
                        // Рассчитываем размеры с сохранением пропорций
                        const maxWidth = window.innerWidth * 0.7;
                        const maxHeight = window.innerHeight * 0.6;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        if (height > maxHeight) {
                            width = (maxHeight / height) * width;
                            height = maxHeight;
                        }

                        // Устанавливаем размеры canvas
                        canvas.width = width;
                        canvas.height = height;

                        // Рисуем изображение
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Сохраняем оригинальные данные изображения
                        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Сбрасываем все настройки
                        resetSliders();
                        resetFilters();
                        
                        // Скрываем плейсхолдер
                        placeholder.style.display = 'none';
                        
                        hideLoading();
                    };
                    
                    img.onerror = function() {
                        hideLoading();
                        alert('Ошибка загрузки изображения');
                    };
                    
                    img.src = event.target.result;
                };
                
                reader.onerror = function() {
                    hideLoading();
                    alert('Ошибка чтения файла');
                };
                
                reader.readAsDataURL(file);
            }

            function showLoading() {
                loading.style.display = 'flex';
            }

            function hideLoading() {
                loading.style.display = 'none';
            }

            function applyCurrentSettings() {
                if (!currentImage || isProcessing) return;
                
                isProcessing = true;
                
                // Восстанавливаем оригинальное изображение
                ctx.putImageData(originalImageData, 0, 0);
                
                // Получаем текущие значения
                const brightness = parseInt(brightnessSlider.value);
                const contrast = parseInt(contrastSlider.value);
                const saturation = parseInt(saturationSlider.value);
                const temperature = parseInt(temperatureSlider.value);
                
                // Применяем базовые корректировки
                if (brightness !== 0 || contrast !== 0 || saturation !== 0 || temperature !== 0) {
                    applyBasicAdjustments(brightness, contrast, saturation, temperature);
                }
                
                // Применяем выбранный фильтр
                if (currentFilter !== 'none') {
                    applyFilter(currentFilter);
                }
                
                // Применяем эффекты
                if (activeEffects.size > 0) {
                    applyEffects();
                }
                
                isProcessing = false;
            }

            function applyBasicAdjustments(brightness, contrast, saturation, temperature) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Яркость
                if (brightness !== 0) {
                    const factor = 255 * (brightness / 100);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = clamp(data[i] + factor); // R
                        data[i + 1] = clamp(data[i + 1] + factor); // G
                        data[i + 2] = clamp(data[i + 2] + factor); // B
                    }
                }
                
                // Контраст
                if (contrast !== 0) {
                    const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = clamp(factor * (data[i] - 128) + 128); // R
                        data[i + 1] = clamp(factor * (data[i + 1] - 128) + 128); // G
                        data[i + 2] = clamp(factor * (data[i + 2] - 128) + 128); // B
                    }
                }
                
                // Насыщенность
                if (saturation !== 0) {
                    const factor = 1 + (saturation / 100);
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        data[i] = clamp(gray + (data[i] - gray) * factor); // R
                        data[i + 1] = clamp(gray + (data[i + 1] - gray) * factor); // G
                        data[i + 2] = clamp(gray + (data[i + 2] - gray) * factor); // B
                    }
                }
                
                // Температура
                if (temperature !== 0) {
                    const warm = temperature > 0 ? temperature / 100 : 0;
                    const cold = temperature < 0 ? Math.abs(temperature) / 100 : 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = clamp(data[i] * (1 + warm)); // R
                        data[i + 1] = clamp(data[i + 1] * (1 - cold * 0.5)); // G
                        data[i + 2] = clamp(data[i + 2] * (1 - cold)); // B
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }

            function applyFilter(filterName) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                switch(filterName) {
                    case 'moody':
                        // Moody - темные, атмосферные тона
                        for (let i = 0; i < data.length; i += 4) {
                            // Уменьшаем яркость
                            data[i] = data[i] * 0.8; // R
                            data[i + 1] = data[i + 1] * 0.8; // G
                            data[i + 2] = data[i + 2] * 0.8; // B
                            
                            // Добавляем синий оттенок
                            data[i] = data[i] * 0.9; // R
                            data[i + 1] = data[i + 1] * 0.95; // G
                            data[i + 2] = data[i + 2] * 1.05; // B
                            
                            // Уменьшаем насыщенность
                            const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                            data[i] = gray * 0.3 + data[i] * 0.7;
                            data[i + 1] = gray * 0.3 + data[i + 1] * 0.7;
                            data[i + 2] = gray * 0.3 + data[i + 2] * 0.7;
                        }
                        break;
                        
                    case 'dramatic':
                        // Dramatic - высокий контраст, темные тени
                        for (let i = 0; i < data.length; i += 4) {
                            // Увеличиваем контраст
                            const factor = 1.5;
                            data[i] = clamp(factor * (data[i] - 128) + 128);
                            data[i + 1] = clamp(factor * (data[i + 1] - 128) + 128);
                            data[i + 2] = clamp(factor * (data[i + 2] - 128) + 128);
                            
                            // Затемняем тени
                            const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                            if (brightness < 128) {
                                data[i] = data[i] * 0.7;
                                data[i + 1] = data[i + 1] * 0.7;
                                data[i + 2] = data[i + 2] * 0.7;
                            }
                        }
                        break;
                        
                    case 'vintage':
                        // Vintage - сепия, винтажный эффект
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            // Эффект сепии
                            data[i] = clamp((r * 0.393) + (g * 0.769) + (b * 0.189));
                            data[i + 1] = clamp((r * 0.349) + (g * 0.686) + (b * 0.168));
                            data[i + 2] = clamp((r * 0.272) + (g * 0.534) + (b * 0.131));
                            
                            // Добавляем легкий розовый оттенок
                            data[i] = clamp(data[i] * 1.05);
                            data[i + 2] = clamp(data[i + 2] * 0.95);
                        }
                        break;
                        
                    case 'cinematic':
                        // Cinematic - глубокие тени, насыщенные цвета
                        for (let i = 0; i < data.length; i += 4) {
                            // Увеличиваем насыщенность
                            const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                            data[i] = gray * 0.5 + data[i] * 1.5;
                            data[i + 1] = gray * 0.5 + data[i + 1] * 1.5;
                            data[i + 2] = gray * 0.5 + data[i + 2] * 1.5;
                            
                            // Добавляем синий оттенок в тени
                            if (gray < 128) {
                                data[i] = data[i] * 0.9;
                                data[i
