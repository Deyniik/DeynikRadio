<!DOCTYPE html>
<html>
<head>
    <style>
        .side-panel { flex: 1; background: #191414; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 180px; overflow: hidden; transition: all 0.3s ease; }
        .chat-container { flex: 1; display: flex; flex-direction: column; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; min-height: 200px; }
        .chat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; color: #1DB954; }
        .chat-messages { flex: 1; overflow-y: auto; max-height: none; margin-bottom: 10px; scrollbar-width: thin; scrollbar-color: rgba(29,185,84,0.3) #191414; display: flex; flex-direction: column; }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: #191414; }
        .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(29,185,84,0.3); border-radius: 2px; }
        .message { padding: 6px 8px; margin: 4px 0; background: rgba(40,40,40,0.6); border-radius: 8px; font-size: 0.85rem; line-height: 1.3; word-wrap: break-word; position: relative; transition: all 0.2s ease; }
        .message:hover { background: rgba(40,40,40,0.8); }
        .message-user { font-weight: bold; color: #1DB954; margin-right: 5px; }
        .message-time { font-size: 0.7rem; color: #888; margin-left: 5px; }
        .chat-input-container { display: flex; gap: 8px; margin-top: auto; position: relative; }
        .chat-input { flex: 1; background: rgba(40,40,40,0.8); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 10px 8px 80px; border-radius: 15px; font-size: 0.8rem; outline: none; height: 36px; }
        .chat-input:focus { border-color: #1DB954; }
        .emoji-btn, .gif-btn { position: absolute; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #B3B3B3; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 2; }
        .emoji-btn { left: 8px; }
        .gif-btn { left: 40px; }
        .emoji-btn:hover, .gif-btn:hover { background: rgba(29,185,84,0.2); color: #1DB954; }
        .chat-send-btn { background: rgba(29,185,84,0.3); border: 1px solid #1DB954; color: white; padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease; height: 36px; display: flex; align-items: center; justify-content: center; }
        .chat-send-btn:hover:not(:disabled) { background: rgba(29,185,84,0.5); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="side-panel crt-effect">
        <h2>Сейчас играет</h2>
        <div style="margin: 15px 0;">
            <h3 id="current-station">KISS FM</h3>
            <p>Текущий трек: <span style="color: #1DB954;" id="current-track-info">"Coffee Break"</span></p>
            <p>Исполнитель: <span style="color: #1DB954;" id="current-artist-info">Beatsmith</span></p>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Качество</h3>
            <p id="quality">128 kbps</p>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <i class="fas fa-comments"></i>
                <h3>Чат</h3>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message">
                    <span class="message-user">Система:</span>
                    Добро пожаловать в чат Deynik Radio!
                    <span class="message-time">только что</span>
                </div>
            </div>
            <div class="chat-input-container" id="chat-input-container">
                <button class="emoji-btn" id="emoji-btn">
                    <i class="far fa-smile"></i>
                </button>
                <button class="gif-btn" id="gif-btn">
                    GIF
                </button>
                <input type="text" class="chat-input" id="chat-input" placeholder="Введите сообщение..." maxlength="200">
                <button class="chat-send-btn" id="chat-send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatMessages = document.getElementById('chat-messages');
        
        // Обработчики чата
        chatInput.addEventListener('input', function() {
            chatSendBtn.disabled = this.value.trim() === '';
        });
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !chatSendBtn.disabled) {
                sendMessage();
            }
        });
        
        chatSendBtn.addEventListener('click', sendMessage);
        
        function sendMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;
            
            if (window.parent && window.parent.sendChatMessage) {
                window.parent.sendChatMessage(messageText);
                chatInput.value = '';
                chatSendBtn.disabled = true;
            }
        }
        
        // Функции для обновления из родительского окна
        window.updateStationInfo = function(station) {
            document.getElementById('current-station').textContent = station.name;
            document.getElementById('current-track-info').textContent = station.currentTrack;
            document.getElementById('current-artist-info').textContent = station.currentArtist;
            document.getElementById('quality').textContent = station.quality;
        };
        
        window.addChatMessage = function(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            let timeString = 'только что';
            if (message.timestamp) {
                const time = message.timestamp.toDate ? message.timestamp.toDate() : new Date(message.timestamp);
                timeString = time.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            
            let messageContent = '';
            if (message.gif) {
                messageContent = `
                    <span class="message-user">${message.userName || 'Аноним'}:</span>
                    <img src="${message.gif}" style="max-width: 200px; border-radius: 8px; margin-top: 5px;" alt="GIF">
                    <span class="message-time">${timeString}</span>
                `;
            } else {
                messageContent = `
                    <span class="message-user">${message.userName || 'Аноним'}:</span>
                    ${message.text || ''}
                    <span class="message-time">${timeString}</span>
                `;
            }
            
            messageElement.innerHTML = messageContent;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
    </script>
</body>
</html>
